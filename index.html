<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Algadi Universe v4.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root { --bg: #f8fafc; --accent: #3b82f6; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg); color: #1e293b; transition: all 0.5s ease; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
        
        /* TEMAS DIN√ÅMICOS POR RANGO (Versi√≥n Premium v3) */
        /* Novato: Azul El√©ctrico, vibrante y moderno */
        body[data-rank="0"] { --accent: #2563eb; --bg: #eff6ff; } 
        
        /* Iniciado: Cian El√©ctrico, energ√≠a pura */
        body[data-rank="1"] { --accent: #06b6d4; --bg: #ecfeff; } 
        
        /* Veterano: Violeta Real, estilo premium */
        body[data-rank="2"] { --accent: #8b5cf6; --bg: #f5f3ff; } 
        
        /* Elite: Rosa Ne√≥n, potencia visual m√°xima */
        body[data-rank="3"] { --accent: #f43f5e; --bg: #fff1f2; } 
        
        /* Leyenda: Oro Ambarino, el color del √©xito */
        body[data-rank="4"] { --accent: #d97706; --bg: #fffbeb; }

        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.4); border-radius: 24px; }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-radius: 16px; font-weight: 800; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.95); }

        /* PATATOMETRO VIVO */
        @keyframes shake { 0%, 100% { transform: translate(0,0); } 20% { transform: translate(-2px, 1px); } 40% { transform: translate(2px, -1px); } 60% { transform: translate(-1px, -2px); } 80% { transform: translate(1px, 2px); } }
        .danger-potato { animation: shake 0.3s infinite; border: 2px solid #ef4444 !important; background: #fff1f1 !important; }
        .pulse-orange { animation: pulse-custom 2s infinite; }
        @keyframes pulse-custom { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }

        /* LOGROS (BADGES) */
        .badge-card { background: white; padding: 12px; border-radius: 20px; border: 1px solid #e2e8f0; transition: 0.3s; }
        .badge-card.locked { opacity: 0.5; filter: grayscale(1); }
        .badge-card.unlocked { border-color: var(--accent); background: white; box-shadow: 0 10px 20px -5px rgba(0,0,0,0.05); }
        .badge-progress { height: 4px; background: #f1f5f9; border-radius: 10px; overflow: hidden; margin-top: 8px; }
        .badge-bar { height: 100%; background: var(--accent); transition: width 0.5s; }

        /* NAVEGACI√ìN */
        .nav-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; display: flex; justify-content: space-around; padding: 12px; z-index: 100; }
        .nav-item { color: #94a3b8; transition: 0.3s; padding: 10px 20px; border-radius: 15px; }
        .nav-item.active { background: var(--accent); color: white; }

        /* LEVEL & RANKS */
        .rank-item { display: flex; gap: 12px; margin-bottom: 16px; position: relative; }
        .rank-line { position: absolute; left: 24px; top: 40px; bottom: -20px; width: 2px; background: #e2e8f0; z-index: 0; }
        .rank-item:last-child .rank-line { display: none; }
        .rank-icon { width: 48px; height: 48px; border-radius: 16px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 800; z-index: 10; position: relative; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .rank-content { flex: 1; padding: 12px; background: white; border-radius: 16px; border: 1px solid #e2e8f0; }
        
        .rank-item.locked { opacity: 0.5; filter: grayscale(1); }
        .rank-item.current .rank-icon { background:var( --accent); color: white; border-color: var( --accent); box-shadow: 0 0 0 4px rgba(16,185,129,0.2); }
        .rank-item.current .rank-content { border-color: var( --accent); background: #ecfdf5; }
        .rank-item.unlocked .rank-icon { background: #d1fae5; color: var( --accent); }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .bf-btn { border: 2px solid #e2e8f0; border-radius: 12px; padding: 10px; font-size: 11px; font-weight: 800; background: white; }
        .bf-btn.selected { border-color: var(--accent); background: var(--bg); color: var(--accent); }

        /* Estilos Patat√≥metro‚Ñ¢ Cl√°sico */
        .patata-container { background: linear-gradient(135deg, #fefce8 0%, #fef3c7 100%); position: relative; overflow: hidden; transition: all 0.3s ease; }
        .potato-face { position: absolute; bottom: -15px; right: -15px; font-size: 100px; opacity: 0.15; transform: rotate(15deg); pointer-events: none; transition: all 0.3s ease; }
        
        /* Alarma: Vibraci√≥n solo lateral y vertical (sin inclinaci√≥n) */
        .danger-potato { animation: shake-straight 0.3s infinite; border: 2px solid #ef4444 !important; background: #fee2e2 !important; }
        .danger-potato .potato-face { opacity: 0.4; }

        @keyframes shake-straight { 
            0%, 100% { transform: translate(0,0) rotate(0deg); } 
            20% { transform: translate(-3px, 0); } 
            40% { transform: translate(3px, 0); } 
            60% { transform: translate(-3px, 1px); } 
            80% { transform: translate(3px, -1px); } 
        } 
    </style>
</head>
<body data-rank="0">

    <header class="p-6 pb-2">
        <div class="flex justify-between items-center mb-4">
            <div class="flex items-center gap-3">
                <div id="main-avatar" onclick="setTab('perfil')" class="w-12 h-12 glass shadow-sm flex items-center justify-center text-2xl cursor-pointer border-2 border-white">üë∂</div>
                <div>
                    <h2 id="display-name" class="font-black text-slate-800 leading-tight uppercase text-sm">USER</h2>
                    <div onclick="openRankMenu()" class="flex items-center gap-2 mt-1 cursor-pointer hover:opacity-70 transition">
                        <div class="h-2 w-24 bg-slate-200 rounded-full overflow-hidden">
                            <div id="xp-bar" class="h-full bg-blue-500 transition-all duration-700" style="width: 0%"></div>
                            <div id="xp-bar" class="h-full transition-all duration-700" style="width: 0%"></div>
                        </div>
                        <span id="rank-name" class="text-[9px] font-black uppercase text-blue-600">Novato</span>
                    </div>
                </div>
            </div>
            <div class="bg-orange-500 text-white px-3 py-1.5 rounded-2xl font-black text-[10px] shadow-lg pulse-orange flex items-center gap-1">
                <span class="material-icons-round text-xs">local_fire_department</span> <span id="streak-val">0</span> D√çAS
            </div>
        </div>
        <div id="buff-bar" class="flex gap-2 px-1"></div>
    </header>

    <section class="px-6 mb-6">
        <div class="bg-slate-900 rounded-3xl p-4 text-white relative overflow-hidden shadow-xl">
            <div class="absolute right-[-5px] top-[-5px] text-5xl opacity-20">üîÆ</div>
            <p class="text-[8px] font-black opacity-50 uppercase tracking-widest mb-1">El Or√°culo de Algadi</p>
            <p id="oracle-msg" class="text-xs font-bold italic leading-tight">Analizando patrones gastron√≥micos...</p>
        </div>
    </section>

    <main class="px-6">
        
        <div id="tab-registro" class="tab-content active">
            <div class="glass p-5 shadow-xl mb-6">
                <div class="space-y-4">
                    <select id="turno" onchange="toggleTurno()" class="w-full bg-slate-100 border-none rounded-2xl p-4 font-black text-xs uppercase outline-none">
                        <option value="‚òÄÔ∏è Comida">‚òÄÔ∏è Comida</option>
                        <option value="üåô Cena">üåô Cena</option>
                        <option value="‚òï Desayuno">‚òï Desayuno</option>
                    </select>

                    <div id="form-comida" class="space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="p1" placeholder="1er PLATO" class="flex-1 bg-slate-50 p-4 rounded-2xl font-bold text-xs uppercase outline-none border-2 border-transparent focus:border-blue-300">
                            <label class="w-14 bg-blue-50 border-2 border-dashed border-blue-200 rounded-2xl flex items-center justify-center cursor-pointer text-blue-500">
                                <span class="material-icons-round">photo_camera</span>
                                <input type="file" accept="image/*" capture="environment" class="hidden" onchange="handlePhoto(event)">
                            </label>
                        </div>
                        <input type="text" id="p2" placeholder="2do PLATO" class="w-full bg-slate-50 p-4 rounded-2xl font-bold text-xs uppercase outline-none">
                        <div class="grid grid-cols-2 gap-2">
                            <select id="guarnicion" class="bg-slate-50 p-3 rounded-xl font-bold text-[10px] uppercase outline-none">
                                <option value="" disabled selected>GUARNICI√ìN</option>
                                <option value="üçü PATATAS FRITAS/DADO">üçü PATATAS FRITAS/DADO</option>
                                <option value="ü•î PATATAS COCIDAS/PANADERA">ü•î PATATAS COCIDAS/AL HORNO</option>
                                <option value="ü•ó ENSALADA">ü•ó ENSALADA</option>
                                <option value="ü•ö HUEVO FRITO">ü•ö HUEVO FRITO</option>
                                <option value="üçù PASTA/ARROZ">üçù PASTA/ARROZ</option>
                                <option value="üçé MANZANA AL CURRY">üçé MANZANA AL CURRY</option>
                                <option value="‚ùå NADA">‚ùå NADA</option>
                            </select>
                            <input type="text" id="postre" placeholder="POSTRE" class="bg-slate-50 p-3 rounded-xl font-bold text-[10px] uppercase outline-none">
                        </div>
                        <div id="photo-preview-box" class="hidden relative">
                            <img id="photo-img" class="w-full h-32 object-cover rounded-2xl border-2 border-white shadow-md">
                            <button onclick="clearPhoto()" class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center">√ó</button>
                        </div>
                    </div>

                    <div id="form-desayuno" class="hidden grid grid-cols-3 gap-2"></div>

                    <div class="flex justify-center gap-4 py-2" id="star-rating">
                        <span onclick="setRate(1)" class="material-icons-round text-3xl text-slate-200 cursor-pointer">star</span>
                        <span onclick="setRate(2)" class="material-icons-round text-3xl text-slate-200 cursor-pointer">star</span>
                        <span onclick="setRate(3)" class="material-icons-round text-3xl text-slate-200 cursor-pointer">star</span>
                        <span onclick="setRate(4)" class="material-icons-round text-3xl text-slate-200 cursor-pointer">star</span>
                        <span onclick="setRate(5)" class="material-icons-round text-3xl text-slate-200 cursor-pointer">star</span>
                    </div>

                    <button onclick="guardar()" class="btn-primary w-full py-4 uppercase text-xs tracking-widest flex items-center justify-center gap-2">
                        <span class="material-icons-round">add_task</span> Registrar Ticket
                    </button>
                </div>
            </div>
            <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-2">√öltimos Registros</h3>
            <div id="historial" class="space-y-3 pb-10"></div>
        </div>

       <main id="tab-stats" class="tab-content px-5">
    <div class="bg-white p-2 rounded-2xl mb-6 shadow-sm border flex items-center gap-2 mt-4">
        <span class="material-icons-round text-slate-300 ml-2">search</span>
        <input type="text" oninput="buscar(this.value)" placeholder="BUSCAR PLATO..." class="w-full p-2 outline-none font-bold text-xs uppercase">
    </div>
    <div id="search-results" class="mb-6 hidden"></div>

    <div id="patata-card" class="patata-container rounded-3xl p-6 mb-4 shadow-xl shadow-yellow-500/10 border-2 border-transparent">
        <h3 class="text-[10px] font-black uppercase text-yellow-700 tracking-widest mb-1">Patat√≥metro‚Ñ¢</h3>
        <div class="flex items-end gap-1">
            <span id="patata-val" class="text-5xl font-black text-yellow-900 leading-none">0</span>
            <span class="text-lg font-bold text-yellow-600 mb-1">%</span>
        </div>
        <p class="text-[10px] font-bold text-yellow-800/60 uppercase mt-2">Nivel de almid√≥n</p>
        <div class="w-full bg-white/50 h-3 rounded-full mt-4 overflow-hidden border border-yellow-500/20">
            <div id="patata-bar" class="h-full bg-yellow-500 transition-all duration-1000 w-0"></div>
        </div>
        <div id="patata-face" class="potato-face">ü•î</div>
    </div>

    <div id="patata-warn" class="hidden bg-red-100 text-red-700 p-4 rounded-2xl mb-6 flex items-center gap-3 border border-red-200 animate-pulse">
        <span class="material-icons-round">warning</span>
        <p class="text-[10px] font-black uppercase">¬°ALERTA! Nivel cr√≠tico de patata detectado</p>
    </div>

    <h3 class="text-[10px] font-black text-slate-400 uppercase mb-3 ml-2">Hitos Gastron√≥micos</h3>
    <div id="achievements-grid" class="grid grid-cols-2 gap-3 mb-10"></div>
</main>
        <div id="tab-perfil" class="tab-content text-center">
            <div class="glass p-8 mb-6">
                <div onclick="cambiarAvatar()" class="w-24 h-24 bg-white rounded-3xl mx-auto mb-4 flex items-center justify-center text-5xl shadow-lg border-4 border-slate-50 cursor-pointer">
                    <span id="p-avatar">üë∂</span>
                </div>
                <input type="text" id="p-name" onchange="saveProfileName()" class="text-center font-black text-2xl uppercase outline-none bg-transparent w-full">
                <p id="p-rank-label" class="text-[10px] font-bold opacity-40 uppercase mt-1">Novato</p>
                
                <div class="flex justify-around mt-8">
                    <div><p id="st-total" class="text-xl font-black">0</p><p class="text-[8px] font-bold opacity-40 uppercase">Tickets</p></div>
                    <div><p id="st-xp" class="text-xl font-black">0</p><p class="text-[8px] font-bold opacity-40 uppercase">XP Total</p></div>
                </div>

                <button onclick="generarCarta()" class="mt-8 bg-slate-800 text-white text-[10px] font-black px-6 py-4 rounded-2xl uppercase flex items-center gap-2 mx-auto">
                    <span class="material-icons-round text-sm">share</span> Generar Carta de Duelo
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="exportar()" class="bg-white border p-3 rounded-xl text-[9px] font-black uppercase">Exportar</button>
                <label class="bg-white border p-3 rounded-xl text-[9px] font-black uppercase text-center cursor-pointer">
                    Importar <input type="file" accept=".json,.txt" class="hidden" onchange="importar(event)">
                </label>
                <button onclick="nuke()" class="bg-red-50 border border-red-100 p-3 rounded-xl text-[9px] font-black text-red-400 uppercase col-span-2">Borrar Todo</button>
            </div>
        </div>
    </main>

    <nav class="nav-bar glass shadow-2xl">
        <button onclick="setTab('registro')" id="nav-registro" class="nav-item active"><span class="material-icons-round">restaurant</span></button>
        <button onclick="setTab('stats')" id="nav-stats" class="nav-item"><span class="material-icons-round">insights</span></button>
        <button onclick="setTab('perfil')" id="nav-perfil" class="nav-item"><span class="material-icons-round">person</span></button>
    </nav>

    <div id="modal-ranks" class="fixed inset-0 bg-slate-900/90 z-[200] hidden flex items-center justify-center p-6" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-[32px] w-full max-w-sm p-6 overflow-hidden" onclick="event.stopPropagation()">
            <h2 class="font-black text-xl mb-6">Escala de sufrimiento</h2>
            <div id="ranks-list"></div>
            <button onclick="document.getElementById('modal-ranks').classList.add('hidden')" class="mt-6 w-full p-4 bg-slate-100 rounded-2xl font-black text-xs uppercase">Cerrar</button>
        </div>
    </div>

    <div id="modal-card" class="fixed inset-0 bg-black/95 z-[300] hidden flex flex-col items-center justify-center p-6" onclick="this.classList.add('hidden')">
        <div id="card-capture" class="w-[300px] h-[450px] bg-slate-900 rounded-[30px] p-6 text-white flex flex-col items-center border-4 border-blue-500 relative overflow-hidden">
            <div class="absolute top-[-50px] left-[-50px] w-32 h-32 bg-blue-500/20 blur-3xl"></div>
            <div class="text-[9px] font-black tracking-[0.3em] text-blue-400 mb-6 uppercase">Algadi Legends</div>
            <div class="text-7xl mb-4" id="c-avatar">üë∂</div>
            <h2 id="c-name" class="text-2xl font-black uppercase mb-1">USER</h2>
            <p id="c-rank" class="text-[10px] font-bold text-blue-400 uppercase tracking-widest mb-8">Novato</p>
            <div class="w-full grid grid-cols-2 gap-3 mb-6">
                <div class="bg-white/5 p-3 rounded-2xl text-center border border-white/10">
                    <p id="c-streak" class="text-xl font-black text-orange-400">0</p>
                    <p class="text-[8px] opacity-40 uppercase">Racha</p>
                </div>
                <div class="bg-white/5 p-3 rounded-2xl text-center border border-white/10">
                    <p id="c-xp" class="text-xl font-black text-blue-400">0</p>
                    <p class="text-[8px] opacity-40 uppercase">XP</p>
                </div>
            </div>
            <div class="w-full bg-blue-600/20 p-4 rounded-2xl text-center border border-blue-500/30">
                <p id="c-patata" class="text-3xl font-black text-yellow-400">0%</p>
                <p class="text-[8px] opacity-60 uppercase">Nivel de Patata</p>
            </div>
        </div>
        <p class="text-white/40 text-[10px] font-bold mt-6 uppercase">Captura de pantalla para guardar</p>
    </div>

    <div id="modal-setup" class="fixed inset-0 bg-white z-[400] hidden flex items-center justify-center p-8 text-center">
        <div class="max-w-xs w-full">
            <h1 class="text-3xl font-black mb-8 uppercase">Hola</h1>
            <div onclick="cambiarAvatar()" class="w-24 h-24 bg-slate-100 rounded-[30px] mx-auto mb-6 flex items-center justify-center text-5xl cursor-pointer"><span id="setup-avatar">üë∂</span></div>
            <input type="text" id="setup-name" placeholder="TU NOMBRE" class="w-full bg-slate-100 p-5 rounded-2xl font-black text-center uppercase mb-4 outline-none">
            <button onclick="finishSetup()" class="btn-primary w-full py-5 text-sm uppercase">Empezar aventura</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        let db = JSON.parse(localStorage.getItem('algadi_db_v4')) || [];
        let profile = JSON.parse(localStorage.getItem('algadi_prof_v4')) || { name: '', avatar: 'üë∂', xp: 0, streak: 0 };
        let currentRate = 0, currentPhoto = null, selectedBf = [];

        // 1. Array con colores premium sincronizados
        const RANKS = [
            { xp: 0, t: "Colegial de nuevo ingreso", c: "#2563eb", d: "A√∫n no distingues el lomo del pollo." },
            { xp: 200, t: "Colegial de segundo", c: "#06b6d4", d: "Reconoces el olor del comedor a 100m." },
            { xp: 600, t: "Colegial de tercero", c: "#8b5cf6", d: "Sabes cu√°ndo toca paella sin mirar." },
            { xp: 1200, t: "Colegial becado", c: "#f43f5e", d: "Los cocineros te saludan por tu nombre." },
            { xp: 2500, t: "Germ√°n", c: "#d97706", d: "Eres el due√±o absoluto del comedor." }
        ];

        const AVATARS = ['üë∂', 'üßë‚Äçüç≥', 'ü•î', 'ü¶ñ', 'üëΩ', 'üëë', 'üßõ', 'ü¶Å', 'üïµÔ∏è', 'üçï'];

        // --- CORE ---
        function init() {
            if (!profile.name) document.getElementById('modal-setup').classList.remove('hidden');
            else { updateUI(); renderBf(); runOracle(); }
        }

        function haptic(type) {
            if(!navigator.vibrate) return;
            if(type === 'soft') navigator.vibrate(10);
            if(type === 'success') navigator.vibrate([40, 30, 40]);
            if(type === 'alert') navigator.vibrate([200, 100, 200]);
        }

        function save() {
            localStorage.setItem('algadi_db_v4', JSON.stringify(db));
            localStorage.setItem('algadi_prof_v4', JSON.stringify(profile));
        }

        // --- UI & TABS ---
        function setTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('nav-' + t).classList.add('active');
            haptic('soft');
            if(t==='stats') renderStats();
        }

        function updateUI() {
            const rIdx = getRankIdx(profile.xp);
            const rank = RANKS[rIdx];
            document.body.setAttribute('data-rank', rIdx);
            document.getElementById('display-name').innerText = profile.name;
            document.getElementById('p-name').value = profile.name;
            document.getElementById('main-avatar').innerText = profile.avatar;
            document.getElementById('p-avatar').innerText = profile.avatar;
            document.getElementById('rank-name').innerText = rank.t;
            document.getElementById('rank-name').style.color = rank.c;
            document.getElementById('p-rank-label').innerText = rank.t;
            document.getElementById('streak-val').innerText = profile.streak;
            document.getElementById('st-total').innerText = db.length;
            document.getElementById('st-xp').innerText = profile.xp;

            const next = RANKS[rIdx+1];
            const bar = document.getElementById('xp-bar');
            if(next) {
            const pct = ((profile.xp - rank.xp) / (next.xp - rank.xp)) * 100;
            bar.style.width = pct + '%';
            // Degradado din√°mico entre el color actual y el siguiente
            bar.style.background = `linear-gradient(90deg, ${rank.c}, ${next.c})`;
            } else {
            bar.style.width = '100%';
            bar.style.background = rank.c;
            }

            // Buffs Visuales
            const bBar = document.getElementById('buff-bar');
            bBar.innerHTML = '';
            const today = new Date().toDateString();
            if(db.some(x => x.t.includes('Desayuno') && new Date(x.d).toDateString() === today)) {
                bBar.innerHTML = '<div class="bg-blue-100 text-blue-600 px-2 py-1 rounded-lg text-[8px] font-black border border-blue-200 uppercase">‚ö° Energ√≠a Desayuno ACTIVA</div>';
            }

            renderHistory();
            renderStats();
        }

        function getRankIdx(xp) {
            for(let i = RANKS.length - 1; i >= 0; i--) { if(xp >= RANKS[i].xp) return i; }
            return 0;
        }

        function openRankMenu() {
            const list = document.getElementById('ranks-list');
            const cIdx = getRankIdx(profile.xp);
            list.innerHTML = RANKS.map((r, i) => {
                let status = "locked";
                if (i < cIdx) status = "unlocked";
                else if (i === cIdx) status = "current";
                
                const nextRank = RANKS[i+1];
                // L√≠nea con degradado entre este rango y el siguiente
                const lineStyle = (status !== "locked" && nextRank) 
                    ? `background: linear-gradient(to bottom, ${r.c}, ${nextRank.c})` 
                    : "";
                
                // Icono con su color de rango si est√° desbloqueado
                const iconStyle = (status !== "locked")
                    ? `background: ${r.c}; color: white; border-color: white; box-shadow: 0 4px 12px ${r.c}66;`
                    : "";

                return `
                    <div class="rank-item ${status}">
                        <div class="rank-line" style="${lineStyle}"></div>
                        <div class="rank-icon" style="${iconStyle}">${i + 1}</div>
                        <div class="rank-content" style="${status === 'current' ? `border-color: ${r.c}; background: ${r.c}08;` : ''}">
                            <div class="flex justify-between items-center mb-1">
                                <span class="font-black text-[10px] uppercase" style="color:${status === 'locked' ? '#94a3b8' : r.c}">${r.t}</span>
                                <span class="text-[9px] font-mono opacity-50">${r.xp} XP</span>
                            </div>
                            <p class="text-[9px] text-slate-500 leading-tight">${r.d}</p>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('modal-ranks').classList.remove('hidden');
            haptic('soft');
        }

        // --- REGISTRO ---
        function toggleTurno() {
            const isBf = document.getElementById('turno').value.includes('Desayuno');
            document.getElementById('form-comida').classList.toggle('hidden', isBf);
            document.getElementById('form-desayuno').classList.toggle('hidden', !isBf);
            selectedBf = []; renderBf();
        }

        function renderBf() {
            const items = ['‚òï Caf√©', 'üç´ Colacao', 'üçû Tostada', 'ü•ê Napolitana','üç© Boller√≠a', 'ü•Ø Sandwich', 'üçä Zumo de naranja','üçç Zumo de pi√±a','ü•£ Cereales'];
            document.getElementById('form-desayuno').innerHTML = items.map(it => `
                <button onclick="toggleBfItem(this, '${it}')" class="bf-btn">${it}</button>
            `).join('');
        }

        function toggleBfItem(btn, it) {
            btn.classList.toggle('selected');
            if(selectedBf.includes(it)) selectedBf = selectedBf.filter(x => x !== it);
            else selectedBf.push(it);
            haptic('soft');
        }

        function setRate(n) {
            currentRate = (currentRate === n) ? 0 : n;
            const stars = document.querySelectorAll('#star-rating span');
            stars.forEach((s, i) => s.style.color = (i < currentRate) ? '#fbbf24' : '#e2e8f0');
            haptic('soft');
        }

        function handlePhoto(e) {
            const file = e.target.files[0];
            if(!file) return;
            const r = new FileReader();
            r.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX = 400;
                    const scale = MAX / img.width;
                    canvas.width = MAX; canvas.height = img.height * scale;
                    canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
                    currentPhoto = canvas.toDataURL('image/jpeg', 0.7);
                    document.getElementById('photo-img').src = currentPhoto;
                    document.getElementById('photo-preview-box').classList.remove('hidden');
                };
                img.src = ev.target.result;
            };
            r.readAsDataURL(file);
        }

        function clearPhoto() { currentPhoto = null; document.getElementById('photo-preview-box').classList.add('hidden'); }

        function guardar() {
            const turno = document.getElementById('turno').value;
            let p1, p2, g, po, xp = 10;

            if(turno.includes('Desayuno')) {
                if(selectedBf.length === 0) return alert("¬øQu√© has desayunado?");
                p1 = "DESAYUNO"; p2 = selectedBf.join(', '); g = "NADA"; po = "NADA"; xp = 5;
            } else {
                p1 = document.getElementById('p1').value.toUpperCase() || "NADA";
                p2 = document.getElementById('p2').value.toUpperCase() || "NADA";
                g = document.getElementById('guarnicion').value;
                po = document.getElementById('postre').value.toUpperCase() || "NADA";
                if(p1 === "NADA" && p2 === "NADA") return alert("¬øPlato vac√≠o?");
                if(turno.includes('Cena')) xp = 15;
            }

            db.unshift({ id: Date.now(), t: turno, p1, p2, g, po, r: currentRate, img: currentPhoto, d: new Date().toISOString() });
            
            const today = new Date().toDateString();
            const last = db[1] ? new Date(db[1].d).toDateString() : null;
            if(today !== last) profile.streak++;
            
            profile.xp += xp; save(); haptic('success');
            confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 } });

            // Reset
            document.getElementById('p1').value = ""; document.getElementById('p2').value = "";
            clearPhoto(); setRate(0); selectedBf = []; renderBf();
            updateUI(); runOracle();
        }

        function importar(e) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    // Soporta el formato con encabezado "Backup Algadi" o JSON puro
                    const content = evt.target.result;
                    const jsonPart = content.includes('\n') ? content.split('\n')[1] : content;
                    const raw = JSON.parse(jsonPart);
                    
                    if (raw.db && raw.profile) {
                        db = raw.db; 
                        profile = raw.profile;
                        save(); 
                        location.reload();
                    } else {
                        throw new Error();
                    }
                } catch(err) { 
                    alert("Archivo de backup no v√°lido"); 
                }
            };
            if(e.target.files[0]) reader.readAsText(e.target.files[0]);
        }

        // --- STATS & LOGROS ---
        function renderStats() {
           // Patat√≥metro (Dise√±o cl√°sico con alarma conservada)
        const meals = db.filter(x => !x.t.includes('Desayuno'));
        const patatas = meals.filter(x => x.g.includes('PATATA') || x.p1.includes('PATATA') || x.p2.includes('PATATA')).length;
        const pct = meals.length ? Math.round((patatas/meals.length)*100) : 0;
        
        document.getElementById('patata-val').innerText = pct;
        document.getElementById('patata-bar').style.width = `${pct}%`;
        
        const card = document.getElementById('patata-card');
        const face = document.getElementById('patata-face');
        
        if(pct > 70) { 
            face.innerText = "ü•îüî•"; 
            card.classList.add('danger-potato'); // Mantiene la animaci√≥n de la alarma
            document.getElementById('patata-warn').classList.remove('hidden');
            haptic('alert');
        } else { 
            face.innerText = "ü•î"; 
            card.classList.remove('danger-potato');
            document.getElementById('patata-warn').classList.add('hidden');
        }
            // L√≥gica de Logros (Badges)
            const badges = [
                { id:1, t:"Pionero", d:"Primer registro", cur: db.length, max:1, i:"üåÆ" },
                { id:2, t:"Mr. Patata", d:"80% de patata", cur: pct >= 80 ? 1 : 0, max:1, i:"ü•î" },
                { id:3, t:"Gourmet", d:"5 cr√≠ticas de 5‚òÖ", cur: db.filter(x=>x.r===5).length, max:5, i:"‚≠ê" },
                { id:4, t:"Excelencia", d:"10 cr√≠ticas de 5‚òÖ", cur: db.filter(x=>x.r===5).length, max:10, i:"üíé" },
                { id:5, t:"Cr√≠tico Feroz", d:"10 cr√≠ticas de 1‚òÖ", cur: db.filter(x=>x.r===1).length, max:10, i:"ü§¨" },
                { id:6, t:"Cafein√≥mano", d:"Superar 100 caf√©s", cur: db.filter(x => x.p2.includes('‚òï Caf√©')).length, max:100, i:"‚òï" },
                { id:7, t:"Constante", d:"Racha de 7 d√≠as", cur: profile.streak, max:7, i:"üî•" },
                { id:8, t:"Noct√°mbulo", d:"50 cenas registradas", cur: db.filter(x=>x.t.includes('Cena')).length, max:50, i:"üåô" },
                { id:9, t:"Equilibrado", d:"10 ensaladas de guarnici√≥n", cur: db.filter(x=>x.g.includes('ü•ó ENSALADA')).length, max:10, i:"ü•ó" },
                { id:10, t:"Madrugador", d:"20 desayunos registrados", cur: db.filter(x=>x.t.includes('Desayuno')).length, max:20, i:"üåÖ" }
            ];

            document.getElementById('achievements-grid').innerHTML = badges.map(b => {
                const unlocked = b.cur >= b.max;
                const progress = Math.min(100, (b.cur/b.max)*100);
                return `
                <div class="badge-card ${unlocked ? 'unlocked' : 'locked'}">
                    <div class="flex justify-between items-start">
                        <span class="text-2xl">${b.i}</span>
                        ${unlocked ? '<span class="text-blue-500 material-icons-round text-sm">verified</span>' : ''}
                    </div>
                    <div class="mt-2">
                        <p class="font-black text-[10px] uppercase">${b.t}</p>
                        <p class="text-[8px] text-slate-400 opacity-60 leading-tight">${b.d}</p>
                    </div>
                    <div class="badge-progress"><div class="badge-bar" style="width:${progress}%"></div></div>
                </div>`;
            }).join('');
        }

        function runOracle() {
            const msg = document.getElementById('oracle-msg');
            if(db.length < 3) { msg.innerText = "Necesito al menos 3 registros para ver tu futuro..."; return; }
            const counts = {};
            db.forEach(x => { if(x.p2 !== 'NADA' && !x.t.includes('Desayuno')) counts[x.p2] = (counts[x.p2]||0)+1; });
            const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
            if(sorted.length > 0) {
                const prob = Math.floor(Math.random() * 20) + 70;
                msg.innerText = `Hay un ${prob}% de probabilidad de que hoy el plato estrella sea ${sorted[0][0]}.`;
            } else msg.innerText = "El futuro es incierto, hoy comer√°s lo que el destino dicte.";
        }

        function buscar(q) {
            const res = document.getElementById('search-results');
            if(q.length < 2) { res.classList.add('hidden'); return; }
            const matches = db.filter(x => (x.p1+x.p2).includes(q.toUpperCase()));
            if(matches.length === 0) res.innerHTML = '<p class="text-center text-[10px] opacity-40">SIN RESULTADOS</p>';
            else {
                const avg = (matches.reduce((a, b) => a + b.r, 0) / matches.length).toFixed(1);
                res.innerHTML = `<div class="bg-white p-4 rounded-2xl border-2 border-slate-100"><div class="flex justify-between items-end"><span class="text-xl font-black">${matches.length} <span class="text-[10px] opacity-30 uppercase">VECES</span></span><span class="text-yellow-500 font-black">‚òÖ ${avg}</span></div></div>`;
            }
            res.classList.remove('hidden');
        }

        // --- EXTRAS ---
        function renderHistory() {
            const el = document.getElementById('historial');
            if(db.length === 0) { el.innerHTML = '<p class="text-center py-10 opacity-20 text-xs font-black">VAC√çO</p>'; return; }
            el.innerHTML = db.slice(0, 10).map(i => `
                <div class="glass p-4 flex gap-4 items-center">
                    ${i.img ? `<img src="${i.img}" class="w-16 h-16 rounded-xl object-cover shadow-sm">` : `<div class="w-16 h-16 bg-slate-50 rounded-xl flex items-center justify-center text-[10px] opacity-20 font-black">S/F</div>`}
                    <div class="flex-1">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[8px] font-black text-slate-300 uppercase">${i.t}</span>
                            <span class="text-yellow-500 text-[10px]">${'‚òÖ'.repeat(i.r)}</span>
                        </div>
                        <p class="text-[11px] font-black text-slate-700 leading-tight">${i.t.includes('Desayuno') ? i.p2 : i.p1}</p>
                        ${!i.t.includes('Desayuno') ? `<p class="text-[9px] font-bold text-slate-400 uppercase">${i.p2}</p>` : ''}
                    </div>
                    <button onclick="borrar(${i.id})" class="text-slate-200"><span class="material-icons-round">delete</span></button>
                </div>
            `).join('');
        }

        function generarCarta() {
            const rIdx = getRankIdx(profile.xp);
            const meals = db.filter(x => !x.t.includes('Desayuno'));
            const pCount = meals.filter(x => (x.g+x.p1+x.p2).includes('PATATA')).length;
            const pct = meals.length ? Math.round((pCount/meals.length)*100) : 0;
            document.getElementById('c-avatar').innerText = profile.avatar;
            document.getElementById('c-name').innerText = profile.name;
            document.getElementById('c-rank').innerText = RANKS[rIdx].t;
            document.getElementById('c-streak').innerText = profile.streak;
            document.getElementById('c-xp').innerText = profile.xp;
            document.getElementById('c-patata').innerText = pct + '%';
            document.getElementById('modal-card').classList.remove('hidden');
            haptic('success');
        }

        function cambiarAvatar() {
            const cur = AVATARS.indexOf(profile.avatar);
            profile.avatar = AVATARS[(cur + 1) % AVATARS.length];
            document.getElementById('setup-avatar').innerText = profile.avatar;
            save(); updateUI(); haptic('soft');
        }

        function finishSetup() {
            const n = document.getElementById('setup-name').value;
            if(!n) return alert("Dime tu nombre");
            profile.name = n.toUpperCase();
            profile.avatar = document.getElementById('setup-avatar').innerText;
            save(); document.getElementById('modal-setup').classList.add('hidden'); init();
        }

        function saveProfileName() { profile.name = document.getElementById('p-name').value.toUpperCase(); save(); updateUI(); }
        function borrar(id) { if(confirm("¬øBorrar ticket?")) { db = db.filter(x => x.id !== id); save(); updateUI(); } }
        function nuke() { if(confirm("‚ö†Ô∏è ¬øBORRAR TODO?")) { localStorage.clear(); location.reload(); } }
        function exportar() {
            const blob = new Blob(["Backup Algadi\n" + JSON.stringify({ db, profile })], { type: 'text/plain' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'algadi_backup.json'; a.click();
        }

        init();
    </script>
</body>
</html>
