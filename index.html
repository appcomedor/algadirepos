<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Algadi Universe</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #f8fafc; --accent: #10b981; }
        body { background-color: var(--bg); color: #0f172a; font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; padding-bottom: 140px; }

        /* ANIMACIONES */
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pop { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .anim-float { animation: float 3s ease-in-out infinite; }

        /* UI ELEMENTS */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.8); 
            box-shadow: 0 8px 32px -10px rgba(0, 0, 0, 0.05);
            border-radius: 24px;
        }

        /* LIQUID NAVBAR */
        .liquid-nav {
            position: fixed; bottom: 24px; left: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 30px;
            padding: 8px;
            box-shadow: 0 15px 35px -10px rgba(0,0,0,0.1);
            z-index: 50; display: flex; justify-content: space-around;
        }
        .nav-item { padding: 12px; border-radius: 20px; transition: all 0.3s; width: 33%; text-align: center; color: #94a3b8; }
        .nav-item.active { background: #0f172a; color: white; transform: translateY(-4px); box-shadow: 0 8px 20px -5px rgba(15, 23, 42, 0.3); }
        .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
        .nav-label { font-size: 9px; font-weight: 800; text-transform: uppercase; }

        /* INPUTS & BUTTONS */
        .input-pro { background: #f1f5f9; border: 2px solid transparent; border-radius: 18px; padding: 14px; font-weight: 700; color: #334155; width: 100%; transition: 0.2s; font-size: 12px; }
        .input-pro:focus { background: white; border-color: var(--accent); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1); outline: none; }
        
        .btn-main { 
            background: linear-gradient(135deg, #10b981 0%, #047857 100%); 
            color: white; border-radius: 20px; font-weight: 800; letter-spacing: 1px;
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4); 
            transition: transform 0.1s; 
        }
        .btn-main:active { transform: scale(0.97); }

        /* PATAT√ìMETRO */
        .patata-container {
            background: radial-gradient(circle at 30% 30%, #fefce8, #fef08a);
            border: 4px solid #fde047; position: relative; overflow: hidden;
        }
        .potato-face { font-size: 80px; position: absolute; right: -10px; bottom: -20px; filter: drop-shadow(0 10px 10px rgba(234, 179, 8, 0.4)); transition: 0.3s; }
        .potato-danger { animation: float 0.5s infinite; filter: hue-rotate(-20deg); }

        /* BADGES */
        .badge-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 20px; padding: 12px;
            display: flex; flex-direction: column; gap: 8px; transition: 0.3s; position: relative; overflow: hidden;
        }
        .badge-card.locked { opacity: 0.6; grayscale: 1; background: #f8fafc; }
        .badge-card.unlocked { border-color: #fbbf24; background: linear-gradient(to bottom right, #fff, #fffbeb); box-shadow: 0 10px 20px -5px rgba(251, 191, 36, 0.15); }
        .progress-track { height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #94a3b8; transition: 1s; }
        .unlocked .progress-fill { background: #fbbf24; }

        /* TICKET */
        .ticket {
            background: white; margin-bottom: 16px; position: relative;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.03));
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), 95% 100%, 90% calc(100% - 10px), 85% 100%, 80% calc(100% - 10px), 75% 100%, 70% calc(100% - 10px), 65% 100%, 60% calc(100% - 10px), 55% 100%, 50% calc(100% - 10px), 45% 100%, 40% calc(100% - 10px), 35% 100%, 30% calc(100% - 10px), 25% 100%, 20% calc(100% - 10px), 15% 100%, 10% calc(100% - 10px), 5% 100%, 0 calc(100% - 10px));
            padding-bottom: 20px;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: pop 0.4s ease; }

        .breakfast-btn { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px; padding: 12px; font-size: 10px; font-weight: 700; color: #64748b; transition: 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .breakfast-btn.selected { background: #ecfdf5; border-color: var(--accent); color: #047857; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15); }

        .rating-container { display: flex; justify-content: center; gap: 8px; }
        .star-label { font-size: 2rem; color: #e2e8f0; cursor: pointer; transition: 0.2s; }
        .star-label.active { color: #fbbf24; transform: scale(1.1); filter: drop-shadow(0 0 5px rgba(251, 191, 36, 0.5)); }

        /* LEVEL & RANKS */
        .rank-item { display: flex; gap: 12px; margin-bottom: 16px; position: relative; }
        .rank-line { position: absolute; left: 24px; top: 40px; bottom: -20px; width: 2px; background: #e2e8f0; z-index: 0; }
        .rank-item:last-child .rank-line { display: none; }
        .rank-icon { width: 48px; height: 48px; border-radius: 16px; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 24px; z-index: 10; position: relative; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .rank-content { flex: 1; padding: 12px; background: white; border-radius: 16px; border: 1px solid #e2e8f0; }
        
        .rank-item.locked { opacity: 0.5; filter: grayscale(1); }
        .rank-item.current .rank-icon { background: #10b981; color: white; border-color: #059669; box-shadow: 0 0 0 4px rgba(16,185,129,0.2); }
        .rank-item.current .rank-content { border-color: #10b981; background: #ecfdf5; }
        .rank-item.unlocked .rank-icon { background: #d1fae5; color: #059669; }

        /* HEADER XP BAR */
        #header-xp {
            transition: width 1s ease-in-out, background 1s ease;
        }
    </style>
</head>
<body class="max-w-lg mx-auto">

    <div class="pt-10 px-6 mb-6 flex justify-between items-center animate-in fade-in slide-in-from-top-4">
        <div onclick="openProfile()" class="flex items-center gap-4 cursor-pointer">
            <div id="header-avatar" class="w-14 h-14 bg-white rounded-2xl flex items-center justify-center text-3xl shadow-lg border border-slate-100 anim-float"></div>
            <div>
                <p class="text-[10px] font-black uppercase text-slate-400 tracking-widest">BIENVENIDO,</p>
                <h1 id="header-name" class="text-xl font-extrabold text-slate-800 leading-none truncate max-w-[180px]">...</h1>
                
                <div onclick="showLevelMenu(); event.stopPropagation()" class="flex items-center gap-1 mt-1 cursor-pointer hover:opacity-80 transition group">
                    <div class="h-2 w-24 bg-slate-200 rounded-full overflow-hidden border border-slate-100 shadow-inner">
                        <div id="header-xp" class="h-full w-0"></div>
                    </div>
                    <span id="header-lvl" class="text-[9px] font-bold text-indigo-500 group-hover:scale-110 transition-transform">LVL 1</span>
                </div>
            </div>
        </div>
    </div>

    <div id="content-area">
        
        <main id="tab-registro" class="tab-content active px-5">
            <div class="glass-panel p-6 mb-8 relative">
                <div class="space-y-4">
                    <select id="turno" onchange="toggleForm()" class="input-pro border-emerald-500/20 text-emerald-800 bg-emerald-50/50">
                        <option value="‚òÄÔ∏è Comida">‚òÄÔ∏è Comida (+10 XP)</option>
                        <option value="üåô Cena">üåô Cena (+15 XP)</option>
                        <option value="‚òï Desayuno">‚òï Desayuno (+5 XP)</option>
                    </select>

                    <div id="form-comida" class="space-y-3">
                        <input type="text" id="primero" placeholder="1¬∫ PLATO" class="input-pro uppercase">
                        <input type="text" id="segundo" placeholder="2¬∫ PLATO" class="input-pro uppercase">
                        <div class="flex gap-2">
                            <select id="guarnicion" class="input-pro w-2/3 text-[11px] uppercase">
                                <option value="" disabled selected>GUARNICI√ìN</option>
                                <option value="üçü PATATAS FRITAS/DADO">üçü PATATAS FRITAS</option>
                                <option value="ü•î PATATAS COCIDAS/PANADERA">ü•î PATATAS COCIDAS</option>
                                <option value="ü•ó ENSALADA">ü•ó ENSALADA</option>
                                <option value="ü•ö HUEVO FRITO">ü•ö HUEVO FRITO</option>
                                <option value="üçù PASTA/ARROZ">üçù PASTA/ARROZ</option>
                                <option value="üçé MANZANA AL CURRY">üçé MANZANA AL CURRY</option>
                                <option value="‚ùå NADA">‚ùå NADA</option>
                            </select>
                            <input type="text" id="postre" placeholder="POSTRE" class="input-pro w-1/3 text-[11px] uppercase">
                        </div>
                    </div>

                    <div id="form-desayuno" class="hidden grid grid-cols-3 gap-2">
                        <button onclick="toggleItem(this, 'Caf√©')" class="breakfast-btn"><span>‚òï</span>Caf√©</button>
                        <button onclick="toggleItem(this, 'Colacao')" class="breakfast-btn"><span>üç´</span>Colacao</button>
                        <button onclick="toggleItem(this, 'Zumo de naranja')" class="breakfast-btn"><span>üçä</span>Zumo Naranja</button>
                        <button onclick="toggleItem(this, 'Zumo de pi√±a')" class="breakfast-btn"><span>üçç</span>Zumo Pi√±a</button>
                        <button onclick="toggleItem(this, 'Tostadas')" class="breakfast-btn"><span>üçû</span>Tostada</button>
                        <button onclick="toggleItem(this, 'Sandwich')" class="breakfast-btn"><span>ü•ñ</span>Sandwich</button>
                        <button onclick="toggleItem(this, 'Napolitana')" class="breakfast-btn"><span>ü•ê</span>Napolitana</button>
                        <button onclick="toggleItem(this, 'Boller√≠a')" class="breakfast-btn"><span>üç©</span>Boller√≠a</button>
                        <button onclick="toggleItem(this, 'Cereales')" class="breakfast-btn"><span>ü•£</span>Cereales</button>
                    </div>

                    <div class="flex justify-center border-t border-slate-100 pt-4">
                        <div class="rating-container">
                            <span class="star-label" onclick="rate(1)" id="star-1">‚òÖ</span>
                            <span class="star-label" onclick="rate(2)" id="star-2">‚òÖ</span>
                            <span class="star-label" onclick="rate(3)" id="star-3">‚òÖ</span>
                            <span class="star-label" onclick="rate(4)" id="star-4">‚òÖ</span>
                            <span class="star-label" onclick="rate(5)" id="star-5">‚òÖ</span>
                        </div>
                    </div>
                    <p class="text-center text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-[-5px]">Valoraci√≥n (Opcional)</p>

                    <button onclick="guardar()" class="btn-main w-full py-4 text-xs uppercase shadow-lg shadow-emerald-500/30">Imprimir Ticket</button>
                </div>
            </div>
            <div id="historial" class="space-y-4 pb-10"></div>
        </main>

        <main id="tab-stats" class="tab-content px-5">
            <div class="patata-container rounded-3xl p-6 mb-6 shadow-xl shadow-yellow-500/10">
                <h3 class="text-[10px] font-black uppercase text-yellow-700 tracking-widest mb-1">Patat√≥metro‚Ñ¢</h3>
                <div class="flex items-end gap-1">
                    <span id="patata-val" class="text-5xl font-black text-yellow-900 leading-none">0</span>
                    <span class="text-lg font-bold text-yellow-600 mb-1">%</span>
                </div>
                <p class="text-[10px] font-bold text-yellow-800/60 uppercase mt-2">Nivel de almid√≥n</p>
                <div class="w-full bg-white/50 h-3 rounded-full mt-4 overflow-hidden border border-yellow-500/20">
                    <div id="patata-bar" class="h-full bg-yellow-500 transition-all duration-1000 w-0"></div>
                </div>
                <div id="patata-face" class="potato-face">ü•î</div>
            </div>

            <h3 class="text-[10px] font-black uppercase text-slate-400 mb-4 ml-1">Medallero Algadi</h3>
            <div id="badges-grid" class="grid grid-cols-2 gap-3 pb-20"></div>
        </main>

        <main id="tab-perfil" class="tab-content px-5">
            <div class="glass-panel p-8 text-center mb-6">
                <div onclick="cycleAvatar()" class="w-24 h-24 bg-slate-100 rounded-full mx-auto mb-4 flex items-center justify-center text-5xl cursor-pointer shadow-inner border-4 border-white">
                    <span id="profile-avatar-display">üë∂</span>
                </div>
                <p class="text-[9px] font-bold text-slate-400 uppercase mb-2">Toca para cambiar</p>
                <input type="text" id="profile-name-input" onchange="saveProfile()" class="text-center bg-transparent text-xl font-black text-slate-800 border-b-2 border-slate-200 focus:border-emerald-500 outline-none w-full" placeholder="TU NOMBRE">
                
                <div class="mt-6 flex justify-center gap-4 text-xs font-mono text-slate-500">
                    <div>
                        <div class="font-bold text-slate-800 text-lg" id="stat-total-tickets">0</div>
                        <div>TICKETS</div>
                    </div>
                    <div class="w-px bg-slate-200"></div>
                    <div>
                        <div class="font-bold text-slate-800 text-lg" id="stat-total-xp">0</div>
                        <div>XP TOTAL</div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-6 space-y-3">
                <h3 class="text-[10px] font-black uppercase text-slate-400 mb-2">Sistema</h3>
                <button onclick="exportCSV()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-xs">EXPORTAR CSV</button>
                <label class="block w-full bg-white border border-slate-200 py-3 rounded-xl font-bold text-xs text-center text-slate-500 cursor-pointer">
                    IMPORTAR CSV
                    <input type="file" accept=".csv" class="hidden" onchange="importCSV(event)">
                </label>
                <button onclick="nuke()" class="w-full text-red-400 py-2 text-[9px] font-black uppercase">Borrar Partida</button>
            </div>
        </main>

    </div>

    <nav class="liquid-nav">
        <div onclick="switchTab('registro')" id="nav-registro" class="nav-item active">
            <span class="nav-icon">üßæ</span>
            <div class="nav-label">Ticket</div>
        </div>
        <div onclick="switchTab('stats')" id="nav-stats" class="nav-item">
            <span class="nav-icon">üèÜ</span>
            <div class="nav-label">Logros</div>
        </div>
        <div onclick="switchTab('perfil')" id="nav-perfil" class="nav-item">
            <span class="nav-icon">‚öôÔ∏è</span>
            <div class="nav-label">Perfil</div>
        </div>
    </nav>

    <div id="setup-modal" class="fixed inset-0 z-[150] hidden flex items-center justify-center bg-slate-900/80 backdrop-blur-md p-6">
        <div class="glass-panel w-full max-w-sm p-8 text-center animate-pop shadow-2xl">
            <div class="text-4xl mb-4">üëã</div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">¬°Hola!</h2>
            <p class="text-sm text-slate-500 mb-8">Antes de empezar a fichar en el comedor, necesito saber qui√©n eres.</p>
            
            <div class="mb-8">
                <div onclick="setupCycleAvatar()" class="w-24 h-24 bg-white rounded-3xl mx-auto mb-4 flex items-center justify-center text-5xl cursor-pointer shadow-lg border-2 border-emerald-100 hover:scale-105 transition">
                    <span id="setup-avatar-display">üë∂</span>
                </div>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Toca el avatar</p>
            </div>

            <input type="text" id="setup-name" class="input-pro text-center text-lg mb-6 uppercase" placeholder="¬øC√ìMO TE LLAMAS?">
            
            <button onclick="finishSetup()" class="btn-main w-full py-4 text-sm shadow-xl shadow-emerald-500/20">
                EMPEZAR
            </button>
        </div>
    </div>

    <div id="oracle" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-6" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-3xl p-8 max-w-xs w-full text-center shadow-2xl animate-pop">
            <div class="text-5xl mb-4">üîÆ</div>
            <p id="oracle-msg" class="text-lg font-bold text-slate-800 italic leading-tight">"..."</p>
            <p class="text-[9px] font-black text-slate-300 mt-6 uppercase">Toca para cerrar</p>
        </div>
    </div>

    <div id="level-modal" class="fixed inset-0 z-[100] hidden flex items-end sm:items-center justify-center bg-slate-900/60 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-t-3xl sm:rounded-3xl p-6 w-full max-w-md h-[80vh] sm:h-auto overflow-y-auto animate-pop shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-white z-20 pb-2 border-b border-slate-100">
                <h2 class="text-xl font-black text-slate-800 uppercase italic">Tu Trayectoria</h2>
                <button onclick="document.getElementById('level-modal').classList.add('hidden')" class="bg-slate-100 p-2 rounded-full text-slate-400 hover:bg-slate-200">‚úï</button>
            </div>
            <div id="ranks-list" class="pb-10"></div>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let db = JSON.parse(localStorage.getItem('algadi_universe_final')) || [];
        // Profile ahora tiene un flag 'setupDone' o comprobamos si name existe
        let profile = JSON.parse(localStorage.getItem('algadi_u_profile')) || { name: '', avatar: 'üë∂', xp: 0 };
        let r = 0;
        let bfItems = [];
        let setupAvatarIdx = 0;

        // --- RPG CONSTANTS & COLORS ---
        const AVATARS = ['üë∂', 'üßë‚Äçüç≥', 'ü•î', 'ü¶ñ', 'üëΩ', 'üëë', 'üê∑', 'üßõ', 'üëª', 'ü§ñ'];
        
        // Colores para el degradado de la barra (Hex colors)
        // 0: Blue, 1: Indigo, 2: Emerald, 3: Amber, 4: Purple
        const RANKS = [
            {xp:0, t:"Colegial de nuevo ingreso", i:"üë∂", d:"Acabas de llegar, no sabes d√≥nde est√° el ba√±o.", c:"#3b82f6"}, 
            {xp:150, t:"Colegial de segundo", i:"üéì", d:"Ya te sabes los trucos del comedor.", c:"#6366f1"}, 
            {xp:400, t:"Colegial de tercero", i:"üï∂Ô∏è", d:"Veterano de mil batallas gastron√≥micas.", c:"#10b981"}, 
            {xp:800, t:"Becado", i:"üéñÔ∏è", d:"La √©lite del colegio mayor.", c:"#f59e0b"}, 
            {xp:1500, t:"Germ√°n", i:"‚ö°", d:"El Dios supremo del Algadi.", c:"#8b5cf6"}
        ];

        // --- INIT ---
        function init() {
            // Check if setup is needed
            if (!profile.name || profile.name.trim() === '') {
                document.getElementById('setup-modal').classList.remove('hidden');
            } else {
                updateUI();
            }
        }

        // --- SETUP LOGIC ---
        function setupCycleAvatar() {
            setupAvatarIdx = (setupAvatarIdx + 1) % AVATARS.length;
            document.getElementById('setup-avatar-display').innerText = AVATARS[setupAvatarIdx];
        }

        function finishSetup() {
            const nameInput = document.getElementById('setup-name').value.trim();
            if (!nameInput) return alert("¬°Dime tu nombre!");
            
            profile.name = nameInput;
            profile.avatar = AVATARS[setupAvatarIdx];
            save();
            
            document.getElementById('setup-modal').classList.add('hidden');
            updateUI();
        }

        // --- UI UPDATER WRAPPER ---
        function updateUI() {
            document.getElementById('profile-name-input').value = profile.name;
            updateHeader();
            renderHistory();
        }

        // --- LEVELS MENU ---
        function showLevelMenu() {
            const list = document.getElementById('ranks-list');
            list.innerHTML = RANKS.map((rank, idx) => {
                const isUnlocked = profile.xp >= rank.xp;
                const isCurrent = isUnlocked && (RANKS[idx+1] ? profile.xp < RANKS[idx+1].xp : true);
                
                let stateClass = "locked";
                if(isCurrent) stateClass = "current";
                else if(isUnlocked) stateClass = "unlocked";

                return `
                <div class="rank-item ${stateClass}">
                    <div class="rank-line"></div>
                    <div class="rank-icon">${rank.i}</div>
                    <div class="rank-content">
                        <div class="flex justify-between items-center mb-1">
                            <h3 class="font-black text-sm uppercase text-slate-800">${rank.t}</h3>
                            ${isCurrent ? '<span class="text-[8px] font-bold bg-emerald-500 text-white px-2 py-0.5 rounded-full">ACTUAL</span>' : ''}
                        </div>
                        <p class="text-xs text-slate-500 leading-tight mb-2">${rank.d}</p>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${rank.xp} XP REQUERIDOS</div>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('level-modal').classList.remove('hidden');
        }

        // --- STAR RATING ---
        function rate(val) {
            r = (r === val) ? 0 : val;
            for (let i = 1; i <= 5; i++) {
                const el = document.getElementById(`star-${i}`);
                if (i <= r) el.classList.add('active');
                else el.classList.remove('active');
            }
            if (navigator.vibrate) navigator.vibrate(10);
        }

        // --- CORE FUNCTIONS ---
        function toggleForm() {
            const t = document.getElementById('turno').value;
            const isBf = t === '‚òï Desayuno';
            document.getElementById('form-comida').classList.toggle('hidden', isBf);
            document.getElementById('form-desayuno').classList.toggle('hidden', !isBf);
            bfItems = []; document.querySelectorAll('.breakfast-btn').forEach(b=>b.classList.remove('selected'));
        }

        function toggleItem(btn, item) {
            btn.classList.toggle('selected');
            bfItems.includes(item) ? bfItems=bfItems.filter(i=>i!==item) : bfItems.push(item);
            if (navigator.vibrate) navigator.vibrate(10);
        }

        function guardar() {
            const turno = document.getElementById('turno').value;
            let p1, p2, g, po, xpAdd = 10;

            if(turno.includes('Desayuno')) {
                if(bfItems.length===0) return alert("Selecciona algo!");
                p1="DESAYUNO"; p2=bfItems.join(', '); g="NADA"; po="NADA"; xpAdd=5;
            } else {
                p1 = val('primero'); p2 = val('segundo'); g = document.getElementById('guarnicion').value||"NADA"; po = val('postre')||"NADA";
                if(p1==="NADA" && p2==="NADA") return alert("Platos vac√≠os");
                xpAdd = turno.includes('Cena') ? 15 : 10;
            }

            db.unshift({ id: Date.now(), t: turno, p1, p2, g, po, r, d: new Date().toISOString() });
            profile.xp += xpAdd;
            
            save();
            showOracle();
            
            document.getElementById('primero').value=""; document.getElementById('segundo').value=""; document.getElementById('postre').value="";
            bfItems=[]; document.querySelectorAll('.breakfast-btn').forEach(b=>b.classList.remove('selected'));
            rate(0);
            
            if (navigator.vibrate) navigator.vibrate([50,50]);
        }

        function val(id) { return document.getElementById(id).value.toUpperCase().trim() || "NADA"; }
        
        function save() {
            localStorage.setItem('algadi_universe_final', JSON.stringify(db));
            localStorage.setItem('algadi_u_profile', JSON.stringify(profile));
            updateUI();
        }

        // --- UI UPDATES & GRADIENT BAR ---
        function updateHeader() {
            // Determinar Rango Actual y Siguiente
            let currentRankIndex = 0;
            for(let i=0; i<RANKS.length; i++) {
                if(profile.xp >= RANKS[i].xp) currentRankIndex = i;
            }
            
            const currentRank = RANKS[currentRankIndex];
            const nextRank = RANKS[currentRankIndex + 1]; // Undefined si es max lvl
            
            // Calculo Porcentaje
            let pct = 0;
            if (nextRank) {
                // XP relativa al nivel actual
                const xpInLevel = profile.xp - currentRank.xp;
                const levelSpan = nextRank.xp - currentRank.xp;
                pct = Math.min(100, Math.max(0, (xpInLevel / levelSpan) * 100));
            } else {
                pct = 100; // Nivel Maximo
            }

            // Aplicar Textos
            document.getElementById('header-name').innerText = profile.name;
            document.getElementById('header-avatar').innerText = profile.avatar;
            document.getElementById('profile-avatar-display').innerText = profile.avatar;
            document.getElementById('header-lvl').innerText = `LVL ${currentRankIndex + 1}`;
            
            // Aplicar Barra y Gradiente
            const bar = document.getElementById('header-xp');
            bar.style.width = `${pct}%`;
            
            // Gradiente: Color actual -> Color siguiente
            const c1 = currentRank.c;
            const c2 = nextRank ? nextRank.c : currentRank.c; // Si max lvl, color solido
            bar.style.background = `linear-gradient(90deg, ${c1}, ${c2})`;
        }

        function renderHistory() {
            const el = document.getElementById('historial');
            if(db.length===0) { el.innerHTML='<div class="text-center py-10 opacity-30 text-xs font-bold uppercase">Sin tickets</div>'; return; }
            
            el.innerHTML = db.map(i => {
                const color = i.r>=4 ? '#10b981' : (i.r<=2 ? '#ef4444' : '#f59e0b');
                const starDisplay = i.r > 0 ? `<span class="font-black" style="color:${color}">${'‚òÖ'.repeat(i.r)}</span>` : '<span class="text-slate-300 text-[9px] font-bold">SIN NOTA</span>';
                const isBf = i.t.includes('Desayuno');
                
                return `
                <div class="ticket p-4 rounded-xl border border-slate-100">
                    <div class="flex justify-between items-center mb-2 border-b border-dashed border-slate-200 pb-2">
                        <span class="text-[9px] font-mono text-slate-400">#${i.id.toString().slice(-4)}</span>
                        <span class="text-[9px] font-mono text-slate-400">${new Date(i.d).toLocaleDateString()}</span>
                    </div>
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-[9px] font-black uppercase bg-slate-100 text-slate-600 px-2 rounded">${i.t}</span>
                        ${starDisplay}
                    </div>
                    <div class="space-y-1 text-xs text-slate-600 font-mono">
                        ${isBf ? `<div class="font-bold">${i.p2}</div>` : `
                        <div class="flex justify-between"><span>1. ${i.p1.substring(0,18)}</span></div>
                        <div class="flex justify-between font-bold text-slate-800"><span>2. ${i.p2.substring(0,18)}</span></div>
                        ${i.g!=='NADA'?`<div class="text-[10px] text-slate-400 pl-4">+ ${i.g}</div>`:''}
                        ${i.po!=='NADA'?`<div class="mt-1 pt-1 border-t border-slate-50 text-[9px]">üç∞ ${i.po}</div>`:''}
                        `}
                    </div>
                    <button onclick="del(${i.id})" class="absolute top-2 right-2 text-red-300 hover:text-red-500 font-bold px-2">√ó</button>
                </div>`;
            }).join('');
        }

        function renderStats() {
            // Patat√≥metro
            const meals = db.filter(x => !x.t.includes('Desayuno'));
            const patatas = meals.filter(x => x.g.includes('PATATA') || x.p1.includes('PATATA') || x.p2.includes('PATATA')).length;
            const pct = meals.length ? Math.round((patatas/meals.length)*100) : 0;
            
            document.getElementById('patata-val').innerText = pct;
            document.getElementById('patata-bar').style.width = `${pct}%`;
            
            const face = document.getElementById('patata-face');
            if(pct > 70) { face.innerText = "ü•îüî•"; face.classList.add('potato-danger'); } 
            else { face.innerText = "ü•î"; face.classList.remove('potato-danger'); }

            // Badges Pro Logic
            const cafes = db.filter(x => x.p2.includes('Caf√©')).length;
            const lomos = db.filter(x => x.p2.includes('LOMO') || x.p1.includes('LOMO')).length;
            
            const badges = [
                { id:1, t:"Primer Trauma", d:"Registra 1 comida", cur: db.length, max:1, i:"üåÆ" },
                { id:2, t:"Buenos d√≠as", d:"100 Caf√©s bebidos", cur: cafes, max:100, i:"‚òï" },
                { id:3, t:"Mr. Potato", d:"70% Dieta Patata", cur: pct, max:70, i:"ü•î" },
                { id:4, t:"Adobado", d:"20 Lomos comidos", cur: lomos, max:20, i:"ü•©" },
                { id:5, t:"Algadi Premium", d:"Pon un 5 estrellas", cur: db.some(x=>x.r===5)?1:0, max:1, i:"‚≠ê" },
                { id:6, t:"Superviviente", d:"Pon un 1 estrella", cur: db.some(x=>x.r===1)?1:0, max:1, i:"ü§¢" }
            ];

            document.getElementById('badges-grid').innerHTML = badges.map(b => {
                const unlocked = b.cur >= b.max;
                const progress = Math.min(100, (b.cur/b.max)*100);
                const displayCur = unlocked ? b.max : b.cur;
                
                return `
                <div class="badge-card ${unlocked ? 'unlocked' : 'locked'}">
                    <div class="flex justify-between items-start">
                        <span class="text-2xl">${b.i}</span>
                        ${unlocked ? '<span class="text-emerald-500 font-bold text-xs">‚úÖ</span>' : ''}
                    </div>
                    <div>
                        <p class="font-black text-[10px] uppercase text-slate-800">${b.t}</p>
                        <p class="text-[9px] text-slate-400 leading-tight">${b.d}</p>
                    </div>
                    <div class="mt-auto">
                        <div class="flex justify-between text-[8px] font-bold text-slate-400 mb-1">
                            <span>${unlocked ? 'COMPLETADO' : 'PROGRESO'}</span>
                            <span>${displayCur}/${b.max}</span>
                        </div>
                        <div class="progress-track"><div class="progress-fill" style="width:${progress}%"></div></div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- UTILS & PROFILE ---
        function cycleAvatar() {
            let idx = AVATARS.indexOf(profile.avatar);
            profile.avatar = AVATARS[(idx + 1) % AVATARS.length];
            save();
        }
        function saveProfile() { profile.name = document.getElementById('profile-name-input').value; save(); }
        function showOracle() {
            const m = ["La patata te observa.", "Indigesti√≥n inminente.", "Recibes 1 indigesti√≥n por participar en esta actividad", "9 de cada 10 mec√°nicos recomiendan los san aceites", "¬øOtra vez lomo?", "Algadio Rodr√≠guez aprueba esto"];
            document.getElementById('oracle-msg').innerText = m[Math.floor(Math.random()*m.length)];
            document.getElementById('oracle').classList.remove('hidden');
        }
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab-${t}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-${t}`).classList.add('active');
            if(t==='stats') renderStats();
        }
        function del(id) { if(confirm("¬øBorrar?")) { db=db.filter(x=>x.id!==id); save(); } }
        function nuke() { if(confirm("¬øBorrar TODO?")) { localStorage.removeItem('algadi_universe_final'); localStorage.removeItem('algadi_u_profile'); location.reload(); } }
        
        // CSV
        function exportCSV() {
            let csv = "Turno,1o,2o,Guarnicion,Postre,Rating,Fecha\n" + db.map(i => `"${i.t}","${i.p1}","${i.p2}","${i.g}","${i.po}",${i.r},"${i.d}"`).join("\n");
            let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = 'algadi_universe.csv'; a.click();
        }
        function importCSV(e) {
            const r = new FileReader();
            r.onload = (evt) => {
                let lines = evt.target.result.split('\n').slice(1);
                db = [...db, ...lines.filter(l=>l.trim()).map(l => {
                    const [t,p1,p2,g,po,r,d] = l.split(',').map(s=>s.replace(/"/g,''));
                    return {id:Date.now()+Math.random(),t,p1,p2,g,po,r:parseInt(r),d};
                })]; save();
            }; r.readAsText(e.target.files[0]);
        }

        init();
    </script>
</body>
</html>
